pipeline {
    agent any

    stages {
        stage('Build') {
            steps {
                // Get some code from a GitHub repository
                git 'https://github.com/2206-devops-batch/ChrisB-Project1'
                // Set Up A Virtual Environment (.venv)
                sh 'python3 -m venv .venv && . .venv/bin/activate'
                // Install Pip & Requirements
                sh 'python3 install -U pip && pip install -r requirements.txt'
            }
        }
        stage('Test'){
            steps {
                // Run pytest
                sh 'python3 -m pytest app-test.py'
            }
        }
        stage ('Deploy') {
            // steps{
            //     sh 'cd ChirsB-Project1 && git pull'
            //     sh 'docker-compose up -d --build'
            // }
            steps {
                archiveArtifacts artifacts: "archiveArtifacts artifacts: '$WORKSPACE/*'", followSymlinks: false, onlyIfSuccessful: true
                sh "docker system prune -af"
                sh "docker build -t Project1 $WORKSPACE"
                sh "docker-compose up -d"
            }
        }
        stage ('Discord') {
            steps{
                discordSend description: '', enableArtifactsList: true, footer: '', image: '', link: 'env.BUILD_URL', result: 'SUCCESS', scmWebUrl: '', thumbnail: '', title: 'Project1', webhookURL: 'https://discord.com/api/webhooks/993998749078655168/H83c2vvdFvmcGggkGKejXcGJBfyZqX8SEfNuxG1KzapDwjr7c9uIUzXxokX_rJUFO8-D'
            }
        }
    }
}
